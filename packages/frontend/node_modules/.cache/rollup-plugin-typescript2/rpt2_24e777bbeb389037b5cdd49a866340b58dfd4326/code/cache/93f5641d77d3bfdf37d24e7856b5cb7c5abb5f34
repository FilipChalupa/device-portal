{"code":"import { __awaiter, __generator } from \"tslib\";\nimport { delay } from '../delay';\nimport { settings } from '../settings';\nvar Peer = /** @class */ (function () {\n    function Peer(room, options) {\n        if (options === void 0) { options = {}; }\n        var _a, _b, _c;\n        this.room = room;\n        this.isDestroyed = false;\n        this.connection = null;\n        this.channel = null;\n        this.value = null;\n        this.socket = null;\n        this.onValue = options.onValue;\n        this.sendLastValueOnConnectAndReconnect =\n            (_a = options.sendLastValueOnConnectAndReconnect) !== null && _a !== void 0 ? _a : true;\n        this.websocketSignalingServer =\n            (_b = options.websocketSignalingServer) !== null && _b !== void 0 ? _b : 'ws://localhost:8080';\n        this.iceServers = (_c = options.iceServers) !== null && _c !== void 0 ? _c : settings.iceServers;\n        this.run();\n    }\n    Peer.prototype.run = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var error_1;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        _a.trys.push([0, 2, , 3]);\n                        return [4 /*yield*/, this.connect()];\n                    case 1:\n                        _a.sent();\n                        return [3 /*break*/, 3];\n                    case 2:\n                        error_1 = _a.sent();\n                        queueMicrotask(function () {\n                            throw error_1;\n                        });\n                        return [3 /*break*/, 3];\n                    case 3: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Peer.prototype.connect = function () {\n        var _this = this;\n        return new Promise(function (resolve, reject) {\n            if (_this.isDestroyed) {\n                return reject(new Error('Peer is destroyed'));\n            }\n            _this.socket = new WebSocket(_this.websocketSignalingServer);\n            _this.socket.onopen = function () {\n                var _a;\n                (_a = _this.socket) === null || _a === void 0 ? void 0 : _a.send(JSON.stringify({ type: 'join-room', room: _this.room }));\n                _this.initializeConnectionAndChannel();\n                resolve();\n            };\n            _this.socket.onmessage = function (event) {\n                var message = JSON.parse(event.data);\n                switch (message.type) {\n                    case 'offer':\n                        _this.handleOffer(message.data);\n                        break;\n                    case 'answer':\n                        _this.handleAnswer(message.data);\n                        break;\n                    case 'ice-candidate':\n                        _this.handleIceCandidate(message.data);\n                        break;\n                }\n            };\n            _this.socket.onclose = function () { return __awaiter(_this, void 0, void 0, function () {\n                return __generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            this.close();\n                            if (!!this.isDestroyed) return [3 /*break*/, 3];\n                            return [4 /*yield*/, delay(1000)];\n                        case 1:\n                            _a.sent();\n                            return [4 /*yield*/, this.run()]; // Reconnect\n                        case 2:\n                            _a.sent(); // Reconnect\n                            _a.label = 3;\n                        case 3: return [2 /*return*/];\n                    }\n                });\n            }); };\n            _this.socket.onerror = function (error) {\n                console.error('WebSocket error:', error);\n                _this.close();\n                reject(error);\n            };\n        });\n    };\n    Peer.prototype.handleIceCandidate = function (candidate) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!this.connection) return [3 /*break*/, 2];\n                        return [4 /*yield*/, this.connection.addIceCandidate(new RTCIceCandidate(candidate))];\n                    case 1:\n                        _a.sent();\n                        _a.label = 2;\n                    case 2: return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Peer.prototype.close = function () {\n        var _a, _b, _c;\n        (_a = this.connection) === null || _a === void 0 ? void 0 : _a.close();\n        this.connection = null;\n        (_b = this.channel) === null || _b === void 0 ? void 0 : _b.close();\n        this.channel = null;\n        (_c = this.socket) === null || _c === void 0 ? void 0 : _c.close();\n        this.socket = null;\n    };\n    Peer.prototype.destroy = function () {\n        this.isDestroyed = true;\n        this.close();\n    };\n    Peer.prototype.sendMessage = function (type, data) {\n        var _a;\n        if (((_a = this.socket) === null || _a === void 0 ? void 0 : _a.readyState) === WebSocket.OPEN) {\n            this.socket.send(JSON.stringify({ type: type, room: this.room, data: data }));\n        }\n    };\n    Peer.prototype.setAndShareLocalDescription = function (description) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!this.connection) {\n                            throw new Error('Connection is not initialized');\n                        }\n                        return [4 /*yield*/, this.connection.setLocalDescription(description)];\n                    case 1:\n                        _a.sent();\n                        this.sendMessage(description.type, description);\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Peer.prototype.shareNewIceCandidate = function (event) {\n        if (event.candidate) {\n            this.sendMessage('ice-candidate', event.candidate.toJSON());\n        }\n    };\n    Peer.prototype.send = function (value) {\n        var _a;\n        if (((_a = this.channel) === null || _a === void 0 ? void 0 : _a.readyState) === 'open') {\n            this.channel.send(value);\n        }\n        this.value = { value: value };\n    };\n    Peer.prototype.initializeConnectionAndChannel = function () {\n        var _this = this;\n        this.connection = new RTCPeerConnection({ iceServers: this.iceServers });\n        this.connection.onicecandidate = this.shareNewIceCandidate.bind(this);\n        if (this.role === 'initiator') {\n            this.channel = this.connection.createDataChannel(settings.channel.label, {\n                negotiated: true,\n                id: settings.channel.id,\n            });\n            this.channel.onopen = function () {\n                var _a;\n                if (_this.value && _this.sendLastValueOnConnectAndReconnect) {\n                    (_a = _this.channel) === null || _a === void 0 ? void 0 : _a.send(_this.value.value);\n                }\n            };\n            this.channel.onmessage = function (event) {\n                var _a;\n                (_a = _this.onValue) === null || _a === void 0 ? void 0 : _a.call(_this, event.data);\n            };\n        }\n        else {\n            this.connection.ondatachannel = function (event) {\n                _this.channel = event.channel;\n                _this.channel.onopen = function () {\n                    var _a;\n                    if (_this.value && _this.sendLastValueOnConnectAndReconnect) {\n                        (_a = _this.channel) === null || _a === void 0 ? void 0 : _a.send(_this.value.value);\n                    }\n                };\n                _this.channel.onmessage = function (event) {\n                    var _a;\n                    (_a = _this.onValue) === null || _a === void 0 ? void 0 : _a.call(_this, event.data);\n                };\n            };\n        }\n    };\n    return Peer;\n}());\nexport { Peer };\n//# sourceMappingURL=Peer.js.map","references":["/home/onset/z/react-device-portal/packages/frontend/src/delay.ts","/home/onset/z/react-device-portal/packages/frontend/src/settings.ts"],"map":"{\"version\":3,\"file\":\"Peer.js\",\"sourceRoot\":\"\",\"sources\":[\"../../../../../src/webrtc/Peer.ts\"],\"names\":[],\"mappings\":\"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\"}","dts":{"name":"/home/onset/z/react-device-portal/packages/frontend/node_modules/.cache/rollup-plugin-typescript2/placeholder/webrtc/Peer.d.ts","writeByteOrderMark":false,"text":"export declare abstract class Peer {\n    protected readonly room: string;\n    protected isDestroyed: boolean;\n    protected connection: RTCPeerConnection | null;\n    protected channel: RTCDataChannel | null;\n    protected abstract role: 'initiator' | 'responder';\n    protected value: {\n        value: string;\n    } | null;\n    protected readonly onValue: ((value: string) => void) | undefined;\n    protected readonly sendLastValueOnConnectAndReconnect: boolean;\n    protected readonly websocketSignalingServer: string;\n    protected readonly iceServers: Array<RTCIceServer>;\n    protected socket: WebSocket | null;\n    constructor(room: string, options?: {\n        onValue?: (value: string) => void;\n        sendLastValueOnConnectAndReconnect?: boolean;\n        websocketSignalingServer?: string;\n        iceServers?: Array<RTCIceServer>;\n    });\n    protected run(): Promise<void>;\n    protected connect(): Promise<void>;\n    protected abstract handleOffer(offer: RTCSessionDescriptionInit): void;\n    protected abstract handleAnswer(answer: RTCSessionDescriptionInit): void;\n    protected handleIceCandidate(candidate: RTCIceCandidateInit): Promise<void>;\n    protected close(): void;\n    destroy(): void;\n    protected sendMessage(type: string, data: any): void;\n    protected setAndShareLocalDescription(description: RTCSessionDescriptionInit): Promise<void>;\n    protected shareNewIceCandidate(event: RTCPeerConnectionIceEvent): void;\n    send(value: string): void;\n    protected initializeConnectionAndChannel(): void;\n}\n"}}
