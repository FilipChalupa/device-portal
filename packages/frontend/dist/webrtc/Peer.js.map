{"version":3,"file":"Peer.js","sources":["../../src/webrtc/Peer.ts"],"sourcesContent":["import { delay } from '../delay'\nimport { settings } from '../settings'\n\nexport abstract class Peer {\n\tprotected isDestroyed = false\n\tprotected connection: RTCPeerConnection | null = null\n\tprotected channel: RTCDataChannel | null = null\n\tprotected abstract role: 'initiator' | 'responder'\n\tprotected value: { value: string } | null = null\n\tprotected readonly onValue: ((value: string) => void) | undefined\n\tprotected readonly sendLastValueOnConnectAndReconnect: boolean\n\tprotected readonly websocketSignalingServer: string\n\tprotected readonly iceServers: Array<RTCIceServer>\n\tprotected socket: WebSocket | null = null\n\n\tconstructor(\n\t\tprotected readonly room: string,\n\t\toptions: {\n\t\t\tonValue?: (value: string) => void\n\t\t\tsendLastValueOnConnectAndReconnect?: boolean\n\t\t\twebsocketSignalingServer?: string\n\t\t\ticeServers?: Array<RTCIceServer>\n\t\t} = {},\n\t) {\n\t\tthis.onValue = options.onValue\n\t\tthis.sendLastValueOnConnectAndReconnect =\n\t\t\toptions.sendLastValueOnConnectAndReconnect ?? true\n\t\tthis.websocketSignalingServer =\n\t\t\toptions.websocketSignalingServer ?? 'ws://localhost:8080'\n\t\tthis.iceServers = options.iceServers ?? settings.iceServers\n\t\tthis.run()\n\t}\n\n\tprotected async run() {\n\t\ttry {\n\t\t\tawait this.connect()\n\t\t} catch (error) {\n\t\t\tqueueMicrotask(() => {\n\t\t\t\tthrow error\n\t\t\t})\n\t\t}\n\t}\n\n\tprotected connect(): Promise<void> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (this.isDestroyed) {\n\t\t\t\treturn reject(new Error('Peer is destroyed'))\n\t\t\t}\n\n\t\t\tthis.socket = new WebSocket(this.websocketSignalingServer)\n\n\t\t\tthis.socket.onopen = () => {\n\t\t\t\tthis.socket?.send(JSON.stringify({ type: 'join-room', room: this.room }))\n\t\t\t\tthis.initializeConnectionAndChannel()\n\t\t\t\tresolve()\n\t\t\t}\n\n\t\t\tthis.socket.onmessage = (event) => {\n\t\t\t\tconst message = JSON.parse(event.data)\n\t\t\t\tswitch (message.type) {\n\t\t\t\t\tcase 'offer':\n\t\t\t\t\t\tthis.handleOffer(message.data)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase 'answer':\n\t\t\t\t\t\tthis.handleAnswer(message.data)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase 'ice-candidate':\n\t\t\t\t\t\tthis.handleIceCandidate(message.data)\n\t\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.socket.onclose = async () => {\n\t\t\t\tthis.close()\n\t\t\t\tif (!this.isDestroyed) {\n\t\t\t\t\tawait delay(1000)\n\t\t\t\t\tawait this.run() // Reconnect\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.socket.onerror = (error) => {\n\t\t\t\tconsole.error('WebSocket error:', error)\n\t\t\t\tthis.close()\n\t\t\t\treject(error)\n\t\t\t}\n\t\t})\n\t}\n\n\tprotected abstract handleOffer(offer: RTCSessionDescriptionInit): void\n\tprotected abstract handleAnswer(answer: RTCSessionDescriptionInit): void\n\n\tprotected async handleIceCandidate(candidate: RTCIceCandidateInit) {\n\t\tif (this.connection) {\n\t\t\tawait this.connection.addIceCandidate(new RTCIceCandidate(candidate))\n\t\t}\n\t}\n\n\tprotected close() {\n\t\tthis.connection?.close()\n\t\tthis.connection = null\n\t\tthis.channel?.close()\n\t\tthis.channel = null\n\t\tthis.socket?.close()\n\t\tthis.socket = null\n\t}\n\n\tpublic destroy() {\n\t\tthis.isDestroyed = true\n\t\tthis.close()\n\t}\n\n\tprotected sendMessage(type: string, data: any) {\n\t\tif (this.socket?.readyState === WebSocket.OPEN) {\n\t\t\tthis.socket.send(JSON.stringify({ type, room: this.room, data }))\n\t\t}\n\t}\n\n\tprotected async setAndShareLocalDescription(\n\t\tdescription: RTCSessionDescriptionInit,\n\t) {\n\t\tif (!this.connection) {\n\t\t\tthrow new Error('Connection is not initialized')\n\t\t}\n\t\tawait this.connection.setLocalDescription(description)\n\t\tthis.sendMessage(description.type, description)\n\t}\n\n\tprotected shareNewIceCandidate(event: RTCPeerConnectionIceEvent) {\n\t\tif (event.candidate) {\n\t\t\tthis.sendMessage('ice-candidate', event.candidate.toJSON())\n\t\t}\n\t}\n\n\tpublic send(value: string) {\n\t\tif (this.channel?.readyState === 'open') {\n\t\t\tthis.channel.send(value)\n\t\t}\n\t\tthis.value = { value }\n\t}\n\n\tprotected initializeConnectionAndChannel() {\n\t\tthis.connection = new RTCPeerConnection({ iceServers: this.iceServers })\n\t\tthis.connection.onicecandidate = this.shareNewIceCandidate.bind(this)\n\n\t\tif (this.role === 'initiator') {\n\t\t\tthis.channel = this.connection.createDataChannel(settings.channel.label, {\n\t\t\t\tnegotiated: true,\n\t\t\t\tid: settings.channel.id,\n\t\t\t})\n\t\t\tthis.channel.onopen = () => {\n\t\t\t\tif (this.value && this.sendLastValueOnConnectAndReconnect) {\n\t\t\t\t\tthis.channel?.send(this.value.value)\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.channel.onmessage = (event) => {\n\t\t\t\tthis.onValue?.(event.data)\n\t\t\t}\n\t\t} else {\n\t\t\tthis.connection.ondatachannel = (event) => {\n\t\t\t\tthis.channel = event.channel\n\t\t\t\tthis.channel.onopen = () => {\n\t\t\t\t\tif (this.value && this.sendLastValueOnConnectAndReconnect) {\n\t\t\t\t\t\tthis.channel?.send(this.value.value)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis.channel.onmessage = (event) => {\n\t\t\t\t\tthis.onValue?.(event.data)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n"],"names":["Peer","room","_options$sendLastValu","_options$websocketSig","_options$iceServers","options","arguments","length","undefined","_classCallCheck","_defineProperty","onValue","sendLastValueOnConnectAndReconnect","websocketSignalingServer","iceServers","settings","run","_createClass","key","value","_run","_asyncToGenerator","_regeneratorRuntime","mark","_callee","wrap","_callee$","_context","prev","next","connect","t0","queueMicrotask","stop","apply","_this","Promise","resolve","reject","isDestroyed","Error","socket","WebSocket","onopen","_this$socket","send","JSON","stringify","type","initializeConnectionAndChannel","onmessage","event","message","parse","data","handleOffer","handleAnswer","handleIceCandidate","onclose","_callee2","_callee2$","_context2","close","delay","onerror","error","console","_handleIceCandidate","_callee3","candidate","_callee3$","_context3","connection","addIceCandidate","RTCIceCandidate","_x","_this$connection","_this$channel","_this$socket2","channel","destroy","sendMessage","_this$socket3","readyState","OPEN","_setAndShareLocalDescription","_callee4","description","_callee4$","_context4","setLocalDescription","setAndShareLocalDescription","_x2","shareNewIceCandidate","toJSON","_this$channel2","_this2","RTCPeerConnection","onicecandidate","bind","role","createDataChannel","label","negotiated","id","_this2$channel","_this2$onValue","call","ondatachannel","_this2$channel2","_this2$onValue2"],"mappings":";;;;AAGA,IAAsBA,IAAI,gBAAA,YAAA;EAYzB,SAAAA,IAAAA,CACoBC,IAAY,EAO9B;AAAA,IAAA,IAAAC,qBAAA,EAAAC,qBAAA,EAAAC,mBAAA;AAAA,IAAA,IANDC,OAKC,GAAAC,SAAA,CAAAC,MAAA,GAAA,CAAA,IAAAD,SAAA,CAAA,CAAA,CAAA,KAAAE,SAAA,GAAAF,SAAA,CAAA,CAAA,CAAA,GAAG,EAAE;AAAAG,IAAAA,eAAA,OAAAT,IAAA,CAAA;AAAAU,IAAAA,eAAA,sBAlBiB,KAAK,CAAA;AAAAA,IAAAA,eAAA,qBACoB,IAAI,CAAA;AAAAA,IAAAA,eAAA,kBACV,IAAI,CAAA;AAAAA,IAAAA,eAAA,gBAEH,IAAI,CAAA;AAAAA,IAAAA,eAAA,iBAKX,IAAI,CAAA;IAAA,IAGrBT,CAAAA,IAAY,GAAZA,IAAY;AAQ/B,IAAA,IAAI,CAACU,OAAO,GAAGN,OAAO,CAACM,OAAO;AAC9B,IAAA,IAAI,CAACC,kCAAkC,GAAAV,CAAAA,qBAAA,GACtCG,OAAO,CAACO,kCAAkC,MAAAV,IAAAA,IAAAA,qBAAA,KAAAA,MAAAA,GAAAA,qBAAA,GAAI,IAAI;AACnD,IAAA,IAAI,CAACW,wBAAwB,GAAAV,CAAAA,qBAAA,GAC5BE,OAAO,CAACQ,wBAAwB,MAAAV,IAAAA,IAAAA,qBAAA,KAAAA,MAAAA,GAAAA,qBAAA,GAAI,qBAAqB;AAC1D,IAAA,IAAI,CAACW,UAAU,GAAAV,CAAAA,mBAAA,GAAGC,OAAO,CAACS,UAAU,MAAA,IAAA,IAAAV,mBAAA,KAAAA,MAAAA,GAAAA,mBAAA,GAAIW,QAAQ,CAACD,UAAU;IAC3D,IAAI,CAACE,GAAG,EAAE;AACX;EAAC,OAAAC,YAAA,CAAAjB,IAAA,EAAA,CAAA;IAAAkB,GAAA,EAAA,KAAA;IAAAC,KAAA,EAAA,YAAA;MAAA,IAAAC,IAAA,GAAAC,iBAAA,cAAAC,mBAAA,EAAAC,CAAAA,IAAA,CAED,SAAAC,OAAA,GAAA;AAAA,QAAA,OAAAF,mBAAA,EAAA,CAAAG,IAAA,CAAA,SAAAC,SAAAC,QAAA,EAAA;AAAA,UAAA,OAAA,CAAA,EAAA,QAAAA,QAAA,CAAAC,IAAA,GAAAD,QAAA,CAAAE,IAAA;AAAA,YAAA,KAAA,CAAA;AAAAF,cAAAA,QAAA,CAAAC,IAAA,GAAA,CAAA;AAAAD,cAAAA,QAAA,CAAAE,IAAA,GAAA,CAAA;AAAA,cAAA,OAEQ,IAAI,CAACC,OAAO,EAAE;AAAA,YAAA,KAAA,CAAA;AAAAH,cAAAA,QAAA,CAAAE,IAAA,GAAA,CAAA;AAAA,cAAA;AAAA,YAAA,KAAA,CAAA;AAAAF,cAAAA,QAAA,CAAAC,IAAA,GAAA,CAAA;cAAAD,QAAA,CAAAI,EAAA,GAAAJ,QAAA,CAAA,OAAA,CAAA,CAAA,CAAA,CAAA;AAEpBK,cAAAA,cAAc,CAAC,YAAM;gBACpB,MAAAL,QAAA,CAAAI,EAAA;AACD,eAAC,CAAC;AAAA,YAAA,KAAA,CAAA;AAAA,YAAA,KAAA,KAAA;cAAA,OAAAJ,QAAA,CAAAM,IAAA,EAAA;AAAA;AAAA,SAAA,EAAAT,OAAA,EAAA,IAAA,EAAA,CAAA,CAAA,CAAA,EAAA,CAAA,CAAA,CAAA,CAAA;OAEH,CAAA,CAAA;AAAA,MAAA,SAReR,GAAGA,GAAA;AAAA,QAAA,OAAAI,IAAA,CAAAc,KAAA,CAAA,IAAA,EAAA5B,SAAA,CAAA;AAAA;AAAA,MAAA,OAAHU,GAAG;AAAA,KAAA;AAAA,GAAA,EAAA;IAAAE,GAAA,EAAA,SAAA;AAAAC,IAAAA,KAAA,EAUnB,SAAUW,OAAOA,GAAkB;AAAA,MAAA,IAAAK,KAAA,GAAA,IAAA;AAClC,MAAA,OAAO,IAAIC,OAAO,CAAC,UAACC,OAAO,EAAEC,MAAM,EAAK;QACvC,IAAIH,KAAI,CAACI,WAAW,EAAE;AACrB,UAAA,OAAOD,MAAM,CAAC,IAAIE,KAAK,CAAC,mBAAmB,CAAC,CAAC;AAC9C;QAEAL,KAAI,CAACM,MAAM,GAAG,IAAIC,SAAS,CAACP,KAAI,CAACtB,wBAAwB,CAAC;AAE1DsB,QAAAA,KAAI,CAACM,MAAM,CAACE,MAAM,GAAG,YAAM;AAAA,UAAA,IAAAC,YAAA;AAC1B,UAAA,CAAAA,YAAA,GAAAT,KAAI,CAACM,MAAM,MAAAG,IAAAA,IAAAA,YAAA,KAAXA,MAAAA,IAAAA,YAAA,CAAaC,IAAI,CAACC,IAAI,CAACC,SAAS,CAAC;AAAEC,YAAAA,IAAI,EAAE,WAAW;YAAE/C,IAAI,EAAEkC,KAAI,CAAClC;AAAK,WAAC,CAAC,CAAC;UACzEkC,KAAI,CAACc,8BAA8B,EAAE;AACrCZ,UAAAA,OAAO,EAAE;SACT;AAEDF,QAAAA,KAAI,CAACM,MAAM,CAACS,SAAS,GAAG,UAACC,KAAK,EAAK;UAClC,IAAMC,OAAO,GAAGN,IAAI,CAACO,KAAK,CAACF,KAAK,CAACG,IAAI,CAAC;UACtC,QAAQF,OAAO,CAACJ,IAAI;AACnB,YAAA,KAAK,OAAO;AACXb,cAAAA,KAAI,CAACoB,WAAW,CAACH,OAAO,CAACE,IAAI,CAAC;AAC9B,cAAA;AACD,YAAA,KAAK,QAAQ;AACZnB,cAAAA,KAAI,CAACqB,YAAY,CAACJ,OAAO,CAACE,IAAI,CAAC;AAC/B,cAAA;AACD,YAAA,KAAK,eAAe;AACnBnB,cAAAA,KAAI,CAACsB,kBAAkB,CAACL,OAAO,CAACE,IAAI,CAAC;AACrC,cAAA;AACF;SACA;AAEDnB,QAAAA,KAAI,CAACM,MAAM,CAACiB,OAAO,gBAAArC,iBAAA,cAAAC,mBAAA,EAAAC,CAAAA,IAAA,CAAG,SAAAoC,QAAA,GAAA;AAAA,UAAA,OAAArC,mBAAA,EAAA,CAAAG,IAAA,CAAA,SAAAmC,UAAAC,SAAA,EAAA;AAAA,YAAA,OAAA,CAAA,EAAA,QAAAA,SAAA,CAAAjC,IAAA,GAAAiC,SAAA,CAAAhC,IAAA;AAAA,cAAA,KAAA,CAAA;gBACrBM,KAAI,CAAC2B,KAAK,EAAE;gBAAA,IACP3B,KAAI,CAACI,WAAW,EAAA;AAAAsB,kBAAAA,SAAA,CAAAhC,IAAA,GAAA,CAAA;AAAA,kBAAA;AAAA;AAAAgC,gBAAAA,SAAA,CAAAhC,IAAA,GAAA,CAAA;gBAAA,OACdkC,KAAK,CAAC,IAAI,CAAC;AAAA,cAAA,KAAA,CAAA;AAAAF,gBAAAA,SAAA,CAAAhC,IAAA,GAAA,CAAA;AAAA,gBAAA,OACXM,KAAI,CAACnB,GAAG,EAAE;AAAA,cAAA,KAAA,CAAA;AAAA,cAAA,KAAA,KAAA;gBAAA,OAAA6C,SAAA,CAAA5B,IAAA,EAAA;AAAA;AAAA,WAAA,EAAA0B,QAAA,CAAA;SAEjB,CAAA,CAAA;AAEDxB,QAAAA,KAAI,CAACM,MAAM,CAACuB,OAAO,GAAG,UAACC,KAAK,EAAK;AAChCC,UAAAA,OAAO,CAACD,KAAK,CAAC,kBAAkB,EAAEA,KAAK,CAAC;UACxC9B,KAAI,CAAC2B,KAAK,EAAE;UACZxB,MAAM,CAAC2B,KAAK,CAAC;SACb;AACF,OAAC,CAAC;AACH;AAAC,GAAA,EAAA;IAAA/C,GAAA,EAAA,oBAAA;IAAAC,KAAA,EAAA,YAAA;MAAA,IAAAgD,mBAAA,GAAA9C,iBAAA,cAAAC,mBAAA,GAAAC,IAAA,CAKD,SAAA6C,QAAAA,CAAmCC,SAA8B,EAAA;AAAA,QAAA,OAAA/C,mBAAA,EAAA,CAAAG,IAAA,CAAA,SAAA6C,UAAAC,SAAA,EAAA;AAAA,UAAA,OAAA,CAAA,EAAA,QAAAA,SAAA,CAAA3C,IAAA,GAAA2C,SAAA,CAAA1C,IAAA;AAAA,YAAA,KAAA,CAAA;cAAA,IAC5D,CAAA,IAAI,CAAC2C,UAAU,EAAA;AAAAD,gBAAAA,SAAA,CAAA1C,IAAA,GAAA,CAAA;AAAA,gBAAA;AAAA;AAAA0C,cAAAA,SAAA,CAAA1C,IAAA,GAAA,CAAA;cAAA,OACZ,IAAI,CAAC2C,UAAU,CAACC,eAAe,CAAC,IAAIC,eAAe,CAACL,SAAS,CAAC,CAAC;AAAA,YAAA,KAAA,CAAA;AAAA,YAAA,KAAA,KAAA;cAAA,OAAAE,SAAA,CAAAtC,IAAA,EAAA;AAAA;AAAA,SAAA,EAAAmC,QAAA,EAAA,IAAA,CAAA;OAEtE,CAAA,CAAA;MAAA,SAJeX,kBAAkBA,CAAAkB,EAAA,EAAA;AAAA,QAAA,OAAAR,mBAAA,CAAAjC,KAAA,CAAA,IAAA,EAAA5B,SAAA,CAAA;AAAA;AAAA,MAAA,OAAlBmD,kBAAkB;AAAA,KAAA;AAAA,GAAA,EAAA;IAAAvC,GAAA,EAAA,OAAA;AAAAC,IAAAA,KAAA,EAMlC,SAAU2C,KAAKA,GAAG;AAAA,MAAA,IAAAc,gBAAA,EAAAC,aAAA,EAAAC,aAAA;MACjB,CAAAF,gBAAA,GAAI,IAAA,CAACJ,UAAU,MAAA,IAAA,IAAAI,gBAAA,KAAA,MAAA,IAAfA,gBAAA,CAAiBd,KAAK,EAAE;MACxB,IAAI,CAACU,UAAU,GAAG,IAAI;MACtB,CAAAK,aAAA,GAAI,IAAA,CAACE,OAAO,MAAA,IAAA,IAAAF,aAAA,KAAA,MAAA,IAAZA,aAAA,CAAcf,KAAK,EAAE;MACrB,IAAI,CAACiB,OAAO,GAAG,IAAI;MACnB,CAAAD,aAAA,GAAI,IAAA,CAACrC,MAAM,MAAA,IAAA,IAAAqC,aAAA,KAAA,MAAA,IAAXA,aAAA,CAAahB,KAAK,EAAE;MACpB,IAAI,CAACrB,MAAM,GAAG,IAAI;AACnB;AAAC,GAAA,EAAA;IAAAvB,GAAA,EAAA,SAAA;AAAAC,IAAAA,KAAA,EAED,SAAO6D,OAAOA,GAAG;MAChB,IAAI,CAACzC,WAAW,GAAG,IAAI;MACvB,IAAI,CAACuB,KAAK,EAAE;AACb;AAAC,GAAA,EAAA;IAAA5C,GAAA,EAAA,aAAA;AAAAC,IAAAA,KAAA,EAED,SAAU8D,WAAWA,CAACjC,IAAY,EAAEM,IAAS,EAAE;AAAA,MAAA,IAAA4B,aAAA;AAC9C,MAAA,IAAI,CAAAA,CAAAA,aAAA,GAAI,IAAA,CAACzC,MAAM,MAAAyC,IAAAA,IAAAA,aAAA,KAAXA,MAAAA,GAAAA,MAAAA,GAAAA,aAAA,CAAaC,UAAU,MAAKzC,SAAS,CAAC0C,IAAI,EAAE;QAC/C,IAAI,CAAC3C,MAAM,CAACI,IAAI,CAACC,IAAI,CAACC,SAAS,CAAC;AAAEC,UAAAA,IAAI,EAAJA,IAAI;UAAE/C,IAAI,EAAE,IAAI,CAACA,IAAI;AAAEqD,UAAAA,IAAI,EAAJA;AAAK,SAAC,CAAC,CAAC;AAClE;AACD;AAAC,GAAA,EAAA;IAAApC,GAAA,EAAA,6BAAA;IAAAC,KAAA,EAAA,YAAA;MAAA,IAAAkE,4BAAA,GAAAhE,iBAAA,cAAAC,mBAAA,GAAAC,IAAA,CAED,SAAA+D,QAAAA,CACCC,WAAsC,EAAA;AAAA,QAAA,OAAAjE,mBAAA,EAAA,CAAAG,IAAA,CAAA,SAAA+D,UAAAC,SAAA,EAAA;AAAA,UAAA,OAAA,CAAA,EAAA,QAAAA,SAAA,CAAA7D,IAAA,GAAA6D,SAAA,CAAA5D,IAAA;AAAA,YAAA,KAAA,CAAA;cAAA,IAEjC,IAAI,CAAC2C,UAAU,EAAA;AAAAiB,gBAAAA,SAAA,CAAA5D,IAAA,GAAA,CAAA;AAAA,gBAAA;AAAA;AAAA,cAAA,MACb,IAAIW,KAAK,CAAC,+BAA+B,CAAC;AAAA,YAAA,KAAA,CAAA;AAAAiD,cAAAA,SAAA,CAAA5D,IAAA,GAAA,CAAA;AAAA,cAAA,OAE3C,IAAI,CAAC2C,UAAU,CAACkB,mBAAmB,CAACH,WAAW,CAAC;AAAA,YAAA,KAAA,CAAA;cACtD,IAAI,CAACN,WAAW,CAACM,WAAW,CAACvC,IAAI,EAAEuC,WAAW,CAAC;AAAA,YAAA,KAAA,CAAA;AAAA,YAAA,KAAA,KAAA;cAAA,OAAAE,SAAA,CAAAxD,IAAA,EAAA;AAAA;AAAA,SAAA,EAAAqD,QAAA,EAAA,IAAA,CAAA;OAC/C,CAAA,CAAA;MAAA,SAReK,2BAA2BA,CAAAC,GAAA,EAAA;AAAA,QAAA,OAAAP,4BAAA,CAAAnD,KAAA,CAAA,IAAA,EAAA5B,SAAA,CAAA;AAAA;AAAA,MAAA,OAA3BqF,2BAA2B;AAAA,KAAA;AAAA,GAAA,EAAA;IAAAzE,GAAA,EAAA,sBAAA;AAAAC,IAAAA,KAAA,EAU3C,SAAU0E,oBAAoBA,CAAC1C,KAAgC,EAAE;MAChE,IAAIA,KAAK,CAACkB,SAAS,EAAE;AACpB,QAAA,IAAI,CAACY,WAAW,CAAC,eAAe,EAAE9B,KAAK,CAACkB,SAAS,CAACyB,MAAM,EAAE,CAAC;AAC5D;AACD;AAAC,GAAA,EAAA;IAAA5E,GAAA,EAAA,MAAA;AAAAC,IAAAA,KAAA,EAED,SAAO0B,IAAIA,CAAC1B,KAAa,EAAE;AAAA,MAAA,IAAA4E,cAAA;AAC1B,MAAA,IAAI,CAAAA,CAAAA,cAAA,GAAI,IAAA,CAAChB,OAAO,MAAA,IAAA,IAAAgB,cAAA,KAAA,MAAA,GAAA,MAAA,GAAZA,cAAA,CAAcZ,UAAU,MAAK,MAAM,EAAE;AACxC,QAAA,IAAI,CAACJ,OAAO,CAAClC,IAAI,CAAC1B,KAAK,CAAC;AACzB;MACA,IAAI,CAACA,KAAK,GAAG;AAAEA,QAAAA,KAAK,EAALA;OAAO;AACvB;AAAC,GAAA,EAAA;IAAAD,GAAA,EAAA,gCAAA;AAAAC,IAAAA,KAAA,EAED,SAAU8B,8BAA8BA,GAAG;AAAA,MAAA,IAAA+C,MAAA,GAAA,IAAA;AAC1C,MAAA,IAAI,CAACxB,UAAU,GAAG,IAAIyB,iBAAiB,CAAC;QAAEnF,UAAU,EAAE,IAAI,CAACA;AAAW,OAAC,CAAC;AACxE,MAAA,IAAI,CAAC0D,UAAU,CAAC0B,cAAc,GAAG,IAAI,CAACL,oBAAoB,CAACM,IAAI,CAAC,IAAI,CAAC;AAErE,MAAA,IAAI,IAAI,CAACC,IAAI,KAAK,WAAW,EAAE;AAC9B,QAAA,IAAI,CAACrB,OAAO,GAAG,IAAI,CAACP,UAAU,CAAC6B,iBAAiB,CAACtF,QAAQ,CAACgE,OAAO,CAACuB,KAAK,EAAE;AACxEC,UAAAA,UAAU,EAAE,IAAI;AAChBC,UAAAA,EAAE,EAAEzF,QAAQ,CAACgE,OAAO,CAACyB;AACtB,SAAC,CAAC;AACF,QAAA,IAAI,CAACzB,OAAO,CAACpC,MAAM,GAAG,YAAM;AAC3B,UAAA,IAAIqD,MAAI,CAAC7E,KAAK,IAAI6E,MAAI,CAACpF,kCAAkC,EAAE;AAAA,YAAA,IAAA6F,cAAA;AAC1D,YAAA,CAAAA,cAAA,GAAAT,MAAI,CAACjB,OAAO,cAAA0B,cAAA,KAAA,MAAA,IAAZA,cAAA,CAAc5D,IAAI,CAACmD,MAAI,CAAC7E,KAAK,CAACA,KAAK,CAAC;AACrC;SACA;AACD,QAAA,IAAI,CAAC4D,OAAO,CAAC7B,SAAS,GAAG,UAACC,KAAK,EAAK;AAAA,UAAA,IAAAuD,cAAA;AACnC,UAAA,CAAAA,cAAA,GAAAV,MAAI,CAACrF,OAAO,cAAA+F,cAAA,KAAA,MAAA,IAAZA,cAAA,CAAAC,IAAA,CAAAX,MAAI,EAAW7C,KAAK,CAACG,IAAI,CAAC;SAC1B;AACF,OAAC,MAAM;AACN,QAAA,IAAI,CAACkB,UAAU,CAACoC,aAAa,GAAG,UAACzD,KAAK,EAAK;AAC1C6C,UAAAA,MAAI,CAACjB,OAAO,GAAG5B,KAAK,CAAC4B,OAAO;AAC5BiB,UAAAA,MAAI,CAACjB,OAAO,CAACpC,MAAM,GAAG,YAAM;AAC3B,YAAA,IAAIqD,MAAI,CAAC7E,KAAK,IAAI6E,MAAI,CAACpF,kCAAkC,EAAE;AAAA,cAAA,IAAAiG,eAAA;AAC1D,cAAA,CAAAA,eAAA,GAAAb,MAAI,CAACjB,OAAO,cAAA8B,eAAA,KAAA,MAAA,IAAZA,eAAA,CAAchE,IAAI,CAACmD,MAAI,CAAC7E,KAAK,CAACA,KAAK,CAAC;AACrC;WACA;AACD6E,UAAAA,MAAI,CAACjB,OAAO,CAAC7B,SAAS,GAAG,UAACC,KAAK,EAAK;AAAA,YAAA,IAAA2D,eAAA;AACnC,YAAA,CAAAA,eAAA,GAAAd,MAAI,CAACrF,OAAO,cAAAmG,eAAA,KAAA,MAAA,IAAZA,eAAA,CAAAH,IAAA,CAAAX,MAAI,EAAW7C,KAAK,CAACG,IAAI,CAAC;WAC1B;SACD;AACF;AACD;AAAC,GAAA,CAAA,CAAA;AAAA,CAAA;;;;"}