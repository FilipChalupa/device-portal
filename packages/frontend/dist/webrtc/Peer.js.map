{"version":3,"file":"Peer.js","sources":["../../src/webrtc/Peer.ts"],"sourcesContent":["import { delay } from '../delay'\nimport { settings } from '../settings'\n\nexport abstract class Peer {\n\tprotected isDestroyed = false\n\tprotected connection: RTCPeerConnection | null = null\n\tprotected channel: RTCDataChannel | null = null\n\tprotected abstract role: 'initiator' | 'responder'\n\tprotected value: { value: string } | null = null\n\tprotected readonly onValue: ((value: string) => void) | undefined\n\tprotected readonly sendLastValueOnConnectAndReconnect: boolean\n\tprotected readonly websocketSignalingServer: string\n\tprotected readonly iceServers: Array<RTCIceServer>\n\tprotected socket: WebSocket | null = null\n\n\tconstructor(\n\t\tprotected readonly room: string,\n\t\toptions: {\n\t\t\tonValue?: (value: string) => void\n\t\t\tsendLastValueOnConnectAndReconnect?: boolean\n\t\t\twebsocketSignalingServer?: string\n\t\t\ticeServers?: Array<RTCIceServer>\n\t\t} = {},\n\t) {\n\t\tthis.onValue = options.onValue\n\t\tthis.sendLastValueOnConnectAndReconnect =\n\t\t\toptions.sendLastValueOnConnectAndReconnect ?? true\n\t\tthis.websocketSignalingServer =\n\t\t\toptions.websocketSignalingServer ?? 'ws://localhost:8080'\n\t\tthis.iceServers = options.iceServers ?? settings.iceServers\n\t\tthis.run()\n\t}\n\n\tprotected async run() {\n\t\ttry {\n\t\t\tawait this.connect()\n\t\t} catch (error) {\n\t\t\tqueueMicrotask(() => {\n\t\t\t\tthrow error\n\t\t\t})\n\t\t}\n\t}\n\n\tprotected connect(): Promise<void> {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tif (this.isDestroyed) {\n\t\t\t\treturn reject(new Error('Peer is destroyed'))\n\t\t\t}\n\n\t\t\tthis.socket = new WebSocket(this.websocketSignalingServer)\n\n\t\t\tthis.socket.onopen = () => {\n\t\t\t\tthis.socket?.send(JSON.stringify({ type: 'join-room', room: this.room }))\n\t\t\t\tthis.initializeConnectionAndChannel()\n\t\t\t\tresolve()\n\t\t\t}\n\n\t\t\tthis.socket.onmessage = (event) => {\n\t\t\t\tconst message = JSON.parse(event.data)\n\t\t\t\tswitch (message.type) {\n\t\t\t\t\tcase 'offer':\n\t\t\t\t\t\tthis.handleOffer(message.data)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase 'answer':\n\t\t\t\t\t\tthis.handleAnswer(message.data)\n\t\t\t\t\t\tbreak\n\t\t\t\t\tcase 'ice-candidate':\n\t\t\t\t\t\tthis.handleIceCandidate(message.data)\n\t\t\t\t\t\tbreak\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.socket.onclose = async () => {\n\t\t\t\tthis.close()\n\t\t\t\tif (!this.isDestroyed) {\n\t\t\t\t\tawait delay(1000)\n\t\t\t\t\tawait this.run() // Reconnect\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.socket.onerror = (error) => {\n\t\t\t\tconsole.error('WebSocket error:', error)\n\t\t\t\tthis.close()\n\t\t\t\treject(error)\n\t\t\t}\n\t\t})\n\t}\n\n\tprotected abstract handleOffer(offer: RTCSessionDescriptionInit): void\n\tprotected abstract handleAnswer(answer: RTCSessionDescriptionInit): void\n\n\tprotected async handleIceCandidate(candidate: RTCIceCandidateInit) {\n\t\tif (this.connection) {\n\t\t\tawait this.connection.addIceCandidate(new RTCIceCandidate(candidate))\n\t\t}\n\t}\n\n\tprotected close() {\n\t\tthis.connection?.close()\n\t\tthis.connection = null\n\t\tthis.channel?.close()\n\t\tthis.channel = null\n\t\tthis.socket?.close()\n\t\tthis.socket = null\n\t}\n\n\tpublic destroy() {\n\t\tthis.isDestroyed = true\n\t\tthis.close()\n\t}\n\n\tprotected sendMessage(type: string, data: any) {\n\t\tif (this.socket?.readyState === WebSocket.OPEN) {\n\t\t\tthis.socket.send(JSON.stringify({ type, room: this.room, data }))\n\t\t}\n\t}\n\n\tprotected async setAndShareLocalDescription(\n\t\tdescription: RTCSessionDescriptionInit,\n\t) {\n\t\tif (!this.connection) {\n\t\t\tthrow new Error('Connection is not initialized')\n\t\t}\n\t\tawait this.connection.setLocalDescription(description)\n\t\tthis.sendMessage(description.type, description)\n\t}\n\n\tprotected shareNewIceCandidate(event: RTCPeerConnectionIceEvent) {\n\t\tif (event.candidate) {\n\t\t\tthis.sendMessage('ice-candidate', event.candidate.toJSON())\n\t\t}\n\t}\n\n\tpublic send(value: string) {\n\t\tif (this.channel?.readyState === 'open') {\n\t\t\tthis.channel.send(value)\n\t\t}\n\t\tthis.value = { value }\n\t}\n\n\tprotected initializeConnectionAndChannel() {\n\t\tthis.connection = new RTCPeerConnection({ iceServers: this.iceServers })\n\t\tthis.connection.onicecandidate = this.shareNewIceCandidate.bind(this)\n\n\t\tif (this.role === 'initiator') {\n\t\t\tthis.channel = this.connection.createDataChannel(settings.channel.label, {\n\t\t\t\tnegotiated: true,\n\t\t\t\tid: settings.channel.id,\n\t\t\t})\n\t\t\tthis.channel.onopen = () => {\n\t\t\t\tif (this.value && this.sendLastValueOnConnectAndReconnect) {\n\t\t\t\t\tthis.channel?.send(this.value.value)\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.channel.onmessage = (event) => {\n\t\t\t\tthis.onValue?.(event.data)\n\t\t\t}\n\t\t} else {\n\t\t\tthis.connection.ondatachannel = (event) => {\n\t\t\t\tthis.channel = event.channel\n\t\t\t\tthis.channel.onopen = () => {\n\t\t\t\t\tif (this.value && this.sendLastValueOnConnectAndReconnect) {\n\t\t\t\t\t\tthis.channel?.send(this.value.value)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tthis.channel.onmessage = (event) => {\n\t\t\t\t\tthis.onValue?.(event.data)\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n"],"names":[],"mappings":"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"}